# 서브 서버용 docker-compose (워커 2, 3, 4 담당)
# 사용법:
#   1. git clone 또는 폴더 복사
#   2. docker compose -f docker-compose.sub.yml up -d --build
#   3. curl -X POST http://localhost:8081/batch/start/2
#   4. curl -X POST http://localhost:8081/batch/start/3
#   5. curl -X POST http://localhost:8081/batch/start/4

services:
  batch:
    build: .
    container_name: mohe-batch-sub
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SERVER_PORT: 8080
      # Database (메인 맥 Tailscale IP)
      DB_HOST: 100.99.236.50
      DB_PORT: 16239
      DB_NAME: mohe_db
      DB_USERNAME: mohe_user
      DB_PASSWORD: mohe_password
      # Spring DataSource (명시적 설정)
      SPRING_DATASOURCE_URL: jdbc:postgresql://100.99.236.50:16239/mohe_db
      SPRING_DATASOURCE_USERNAME: mohe_user
      SPRING_DATASOURCE_PASSWORD: mohe_password
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.postgresql.Driver
      # Crawler service (local)
      CRAWLER_BASE_URL: http://crawler:2000
      CRAWLER_TIMEOUT_MINUTES: 2
      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      # Batch worker settings - 총 4워커, 맥북에어는 2,3 담당
      BATCH_TOTAL_WORKERS: 5
      BATCH_THREADS_PER_WORKER: 1
      BATCH_CHUNK_SIZE: 2
      # Async pool settings
      BATCH_ASYNC_CORE_POOL_SIZE: 1
      BATCH_ASYNC_MAX_POOL_SIZE: 2
      BATCH_ASYNC_QUEUE_CAPACITY: 10
      # Image storage (로컬)
      IMAGE_STORAGE_PATH: /app/images
      # Image Processor - 메인 맥의 Tailscale IP
      IMAGE_PROCESSOR_URL: http://100.99.236.50:5200
      # Embedding service
      EMBEDDING_SERVICE_URL: http://100.99.236.50:6000
    volumes:
      - ./images:/app/images
    networks:
      - mohe-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      - crawler

  crawler:
    build: ../MoheCrawler
    container_name: mohe-batch-crawler-air
    ports:
      - "2000:2000"
    environment:
      FLASK_ENV: production
      PYTHONUNBUFFERED: 1
      PORT: 2000
    networks:
      - mohe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  mohe-network:
    driver: bridge
