services:
  # Batch server - connects to external PostgreSQL from MoheSpring
  batch:
    build: .
    container_name: mohe-batch
    ports:
      - "8081:8081"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      # JVM Memory Limit (OOM Prevention)
      JAVA_OPTS: "-Xmx768m -Xms256m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
      # Database (same as MoheSpring)
      DB_HOST: 100.99.236.50
      DB_PORT: 16239
      DB_NAME: mohe_db
      DB_USERNAME: mohe_user
      DB_PASSWORD: mohe_password
      # Crawler service
      CRAWLER_BASE_URL: http://crawler:2000
      CRAWLER_TIMEOUT_MINUTES: 2
      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      # Batch worker settings (distributed across 2 machines)
      # 총 4워커: 이 머신(0,1), 맥북에어(2,3)
      BATCH_TOTAL_WORKERS: 5
      BATCH_THREADS_PER_WORKER: 1
      BATCH_CHUNK_SIZE: 2
      # Async pool settings (reduced for memory)
      BATCH_ASYNC_CORE_POOL_SIZE: 1
      BATCH_ASYNC_MAX_POOL_SIZE: 2
      BATCH_ASYNC_QUEUE_CAPACITY: 10
      # Image storage
      IMAGE_STORAGE_PATH: /app/images
      # Image Processor service
      IMAGE_PROCESSOR_URL: http://app:5200
      # Embedding service
      EMBEDDING_SERVICE_URL: ${EMBEDDING_SERVICE_URL:-http://100.99.236.50:6000}
    volumes:
      # 호스트의 /Mohe/images 디렉토리를 컨테이너에 마운트
      - /Users/andrewlim/Desktop/Mohe/images:/app/images
    networks:
      - mohe-network
      - mohereact_mohe-network
      - moheimageprocessor_default
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Crawler service (MoheCrawler - Flask + Selenium)
  crawler:
    build: ../MoheCrawler
    container_name: mohe-batch-crawler
    ports:
      - "2000:2000"
    environment:
      FLASK_ENV: production
      PYTHONUNBUFFERED: 1
      PORT: 2000
    networks:
      - mohe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  mohe-network:
    driver: bridge
  mohereact_mohe-network:
    external: true
  moheimageprocessor_default:
    external: true
