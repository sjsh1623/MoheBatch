services:
  # Batch server - connects to external PostgreSQL from MoheSpring
  batch:
    build: .
    container_name: mohe-batch
    ports:
      - "8081:8081"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      # Database (same as MoheSpring)
      DB_HOST: 100.99.236.50
      DB_PORT: 16239
      DB_NAME: mohe_db
      DB_USERNAME: mohe_user
      DB_PASSWORD: mohe_password
      # Crawler service
      CRAWLER_BASE_URL: http://crawler:2000
      CRAWLER_TIMEOUT_MINUTES: 30
      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      # Batch worker settings
      BATCH_TOTAL_WORKERS: 3
      BATCH_THREADS_PER_WORKER: 5
      BATCH_CHUNK_SIZE: 10
      # Image storage
      IMAGE_STORAGE_PATH: /app/images
      # Embedding service
      EMBEDDING_SERVICE_URL: ${EMBEDDING_SERVICE_URL:-http://100.99.236.50:6000}
    volumes:
      - batch_images:/app/images
    networks:
      - mohe-network
      - mohereact_mohe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Crawler service (MoheCrawler - Flask + Selenium)
  crawler:
    build: ../MoheCrawler
    container_name: mohe-batch-crawler
    ports:
      - "2000:2000"
    environment:
      FLASK_ENV: production
      PYTHONUNBUFFERED: 1
      PORT: 2000
    networks:
      - mohe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  batch_images:

networks:
  mohe-network:
    driver: bridge
  mohereact_mohe-network:
    external: true
